<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humor Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F5;
        }
        /* Custom styles for a subtle glow effect on focus */
        .focus-glow:focus-within {
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4);
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        .btn-primary:hover {
            background-color: #45a049;
        }
        .btn-secondary {
            background-color: #FFC107;
            color: #212121;
        }
        .btn-secondary:hover {
            background-color: #ffb300;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #FFC107;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-neutral-light text-text-primary flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <!-- App Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-neutral-dark flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-emoji-smile" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.5 3.5 0 0 0 8 11.5a3.5 3.5 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.5 4.5 0 0 1 8 12.5a4.5 4.5 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683M7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5m4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5"/>
                </svg>
                Humor Evaluator
            </h1>
            <p class="text-text-secondary mt-2">Powered by AI. Your feedback makes the jokes better!</p>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition-all duration-300">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16 hidden">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-text-secondary">Fetching a fresh joke for you...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-16 hidden">
                 <p class="text-red-500 font-semibold">Oops! Something went wrong.</p>
                 <p id="error-message" class="text-text-secondary mt-2">Could not fetch a joke. Please try again later.</p>
                 <button id="retry-button" class="mt-6 btn-primary font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Try Again</button>
            </div>

            <!-- Joke Display Card -->
            <div id="joke-card" class="hidden">
                <div class="bg-neutral-light p-6 rounded-lg min-h-[120px] flex items-center justify-center text-center">
                    <p id="joke-text" class="text-xl text-neutral-dark leading-relaxed"></p>
                </div>

                <!-- Feedback Section -->
                <div class="mt-8">
                    <h2 class="text-lg font-semibold text-center text-neutral-dark">How funny was that?</h2>
                    
                    <!-- Star Rating -->
                    <div id="star-rating-container" class="star-rating flex justify-center items-center text-5xl text-gray-300 mt-4" dir="rtl">
                        <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">&#9733;</label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">&#9733;</label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">&#9733;</label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">&#9733;</label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">&#9733;</label>
                    </div>

                    <!-- Text Feedback -->
                    <div class="mt-6">
                        <label for="feedback-text" class="sr-only">Your Feedback (optional)</label>
                        <textarea id="feedback-text" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition focus-glow" placeholder="Your feedback (optional)..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="submit-feedback-button" class="btn-primary font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Submit Feedback</button>
                        <button id="next-joke-button" class="btn-secondary font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Get Another Joke</button>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Confirmation Modal -->
            <div id="feedback-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-xl shadow-2xl p-8 text-center max-w-sm w-full transform transition-all scale-95 opacity-0">
                    <div id="analysis-loader" class="hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-text-secondary">Analyzing your valuable feedback...</p>
                    </div>
                    <div id="analysis-result">
                        <div class="mx-auto bg-green-100 rounded-full h-16 w-16 flex items-center justify-center">
                            <svg class="w-10 h-10 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold mt-4 text-neutral-dark">Thank You!</h2>
                        <div id="feedback-analysis-content" class="text-text-secondary mt-2 text-left">
                            <!-- Analysis content will be injected here -->
                        </div>
                        <button id="modal-next-joke-button" class="mt-6 w-full btn-primary font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Show Me Another Joke</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'https://ai.violass.club/v1'; // This is a placeholder
        const API_KEY = '123'; // IMPORTANT: Replace with a real API key for a real deployment

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');
        const mainContent = document.getElementById('main-content');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const retryButton = document.getElementById('retry-button');
        const jokeCard = document.getElementById('joke-card');
        const jokeText = document.getElementById('joke-text');
        const starRatingContainer = document.getElementById('star-rating-container');
        const feedbackText = document.getElementById('feedback-text');
        const submitFeedbackButton = document.getElementById('submit-feedback-button');
        const nextJokeButton = document.getElementById('next-joke-button');
        const feedbackConfirmationModal = document.getElementById('feedback-confirmation-modal');
        const modalNextJokeButton = document.getElementById('modal-next-joke-button');
        const analysisLoader = document.getElementById('analysis-loader');
        const analysisResult = document.getElementById('analysis-result');
        const feedbackAnalysisContent = document.getElementById('feedback-analysis-content');

        // --- APPLICATION STATE ---
        let currentJoke = '';
        let currentRating = 0;
        let isSubmitting = false;

        // --- MOCK API CLIENT (Simulates network delay and responses) ---
        // In a real application, this would use fetch() to call the actual API.
        const mockApiClient = {
            generateJoke: async () => {
                // This prompt is based on Lyra's finalized prompt structure.
                const prompt = "You are a professional comedian. Generate a short, original, and family-friendly joke. Provide the joke as a JSON object with a single key 'joke'.";
                
                console.log("Mock API Call: generateJoke");
                await new Promise(res => setTimeout(res, 1000)); // Simulate network delay

                // Simulate potential API failure
                if (Math.random() < 0.1) { // 10% chance of failure
                    throw new Error("Failed to connect to the joke generator.");
                }
                
                const jokes = [
                    "Why did the scarecrow win an award? Because he was outstanding in his field!",
                    "What do you call a fake noodle? An impasta!",
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "I told my wife she should embrace her mistakes. She gave me a hug.",
                    "What do you get when you cross a snowman and a vampire? Frostbite.",
                    "Why did the bicycle fall over? Because it was two-tired!"
                ];
                const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
                return { joke: randomJoke };
            },
            analyzeFeedback: async (joke, feedback, rating) => {
                // This prompt is based on Lyra's finalized prompt structure.
                const prompt = `You are a humor analyst. Analyze the following joke and feedback. Output a JSON object with 'sentiment', 'key_points', and 'recommendations'.\n\nJoke: "${joke}"\nFeedback: "${feedback}"\nRating: ${rating}/5`;

                console.log("Mock API Call: analyzeFeedback with data:", { joke, feedback, rating });
                await new Promise(res => setTimeout(res, 1500)); // Simulate analysis delay

                // Mocked analysis based on rating
                let sentiment = 'neutral';
                if (rating >= 4) sentiment = 'positive';
                if (rating <= 2) sentiment = 'negative';

                const key_points = ["Clever wordplay", "Good for all ages"];
                if (feedback.toLowerCase().includes('heard')) {
                    key_points.push("Unoriginal");
                }
                 if (feedback.toLowerCase().includes('cheesy')) {
                    key_points.push("A bit cheesy");
                }

                const recommendations = ["Try a different topic like animals or technology."];
                
                return { sentiment, key_points, recommendations };
            }
        };


        // --- UI LOGIC ---
        const showLoading = () => {
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            jokeCard.classList.add('hidden');
        };

        const showError = (message) => {
            errorMessage.textContent = message;
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            jokeCard.classList.add('hidden');
        };

        const showJokeCard = () => {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            jokeCard.classList.remove('hidden');
        };

        const resetFeedbackForm = () => {
            currentRating = 0;
            // Uncheck all radio buttons
            const stars = starRatingContainer.querySelectorAll('input[type="radio"]');
            stars.forEach(star => star.checked = false);
            feedbackText.value = '';
            submitFeedbackButton.disabled = true;
        };
        
        const fetchAndDisplayJoke = async () => {
            showLoading();
            try {
                const data = await mockApiClient.generateJoke();
                currentJoke = data.joke;
                jokeText.textContent = currentJoke;
                resetFeedbackForm();
                showJokeCard();
            } catch (error) {
                console.error("Error fetching joke:", error);
                showError(error.message);
            }
        };

        const handleSubmitFeedback = async () => {
            if (isSubmitting || currentRating === 0) return;
            isSubmitting = true;

            showFeedbackModal(true); // Show loader in modal

            try {
                const feedback = feedbackText.value;
                const result = await mockApiClient.analyzeFeedback(currentJoke, feedback, currentRating);
                displayAnalysisResult(result);
            } catch (error) {
                console.error("Error analyzing feedback:", error);
                // In a real app, you might show an error in the modal
                hideFeedbackModal();
                alert("Sorry, we couldn't process your feedback right now.");
            } finally {
                isSubmitting = false;
            }
        };

        const showFeedbackModal = (isLoading = false) => {
            feedbackConfirmationModal.classList.remove('hidden');
            setTimeout(() => {
                const modalContent = feedbackConfirmationModal.querySelector('.transform');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            if (isLoading) {
                analysisLoader.classList.remove('hidden');
                analysisResult.classList.add('hidden');
            } else {
                analysisLoader.classList.add('hidden');
                analysisResult.classList.remove('hidden');
            }
        };

        const hideFeedbackModal = () => {
            const modalContent = feedbackConfirmationModal.querySelector('.transform');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                feedbackConfirmationModal.classList.add('hidden');
            }, 200);
        };

        const displayAnalysisResult = (result) => {
            let contentHtml = `<p><strong>Sentiment:</strong> <span class="capitalize">${result.sentiment}</span></p>`;
            if (result.key_points && result.key_points.length > 0) {
                contentHtml += `<p class="mt-2"><strong>Key Points:</strong></p><ul class="list-disc list-inside">`;
                result.key_points.forEach(point => {
                    contentHtml += `<li>${point}</li>`;
                });
                contentHtml += `</ul>`;
            }
            feedbackAnalysisContent.innerHTML = contentHtml;
            showFeedbackModal(false); // Show result in modal
        };

        // --- EVENT LISTENERS ---
        starRatingContainer.addEventListener('change', (e) => {
            if (e.target.name === 'rating') {
                currentRating = parseInt(e.target.value, 10);
                submitFeedbackButton.disabled = false;
            }
        });

        submitFeedbackButton.addEventListener('click', handleSubmitFeedback);
        
        nextJokeButton.addEventListener('click', fetchAndDisplayJoke);
        
        retryButton.addEventListener('click', fetchAndDisplayJoke);

        modalNextJokeButton.addEventListener('click', () => {
            hideFeedbackModal();
            fetchAndDisplayJoke();
        });

        // Close modal on escape key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !feedbackConfirmationModal.classList.contains('hidden')) {
                hideFeedbackModal();
            }
        });
        
        // Close modal on background click
        feedbackConfirmationModal.addEventListener('click', (e) => {
            if (e.target === feedbackConfirmationModal) {
                 hideFeedbackModal();
            }
        });


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check for API Key
             if (API_KEY === 'YOUR_API_KEY_HERE') {
                const warning = document.createElement('div');
                warning.className = 'bg-yellow-200 text-yellow-800 p-4 text-center fixed top-0 left-0 right-0 z-50';
                warning.textContent = 'Warning: API Key not set. The application is running in mock mode.';
                document.body.prepend(warning);
            }
            fetchAndDisplayJoke();
        });
    </script>
</body>
</html>
