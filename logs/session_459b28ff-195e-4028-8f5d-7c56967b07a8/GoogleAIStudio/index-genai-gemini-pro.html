<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uTASe Genesis</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS Variables and Font Imports --- */
        :root {
            --bg-color: #0d0c22;
            --primary-dark: #1a162d;
            --primary-light: #221c35;
            --accent-cyan: #61e2ff;
            --accent-magenta: #e040fb;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --font-body: 'Poppins', sans-serif;
            --font-title: 'Rajdhani', sans-serif;
        }

        /* --- Base and Reset --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: radial-gradient(circle at 25% 25%, rgba(97, 226, 255, 0.1), transparent 30%),
                              radial-gradient(circle at 75% 75%, rgba(224, 64, 251, 0.1), transparent 30%);
            background-attachment: fixed;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Header --- */
        .main-header {
            text-align: center;
            padding: 4rem 1rem 2rem;
        }

        .title {
            font-family: var(--font-title);
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-glow 5s ease-in-out infinite alternate;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            margin-bottom: 2rem;
        }

        .api-key-container {
            max-width: 500px;
            margin: 0 auto 1.5rem auto;
            text-align: left;
        }

        .api-key-container label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        #api-key-input {
            width: 100%;
            padding: 0.7rem;
            margin-top: 0.5rem;
            background-color: var(--primary-dark);
            border: 1px solid var(--primary-light);
            color: var(--text-color);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #api-key-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(97, 226, 255, 0.5);
        }

        .api-key-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            text-align: center;
        }

        #start-genesis-btn {
            font-family: var(--font-title);
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.8rem 2rem;
            border: 2px solid var(--accent-cyan);
            background-color: transparent;
            color: var(--accent-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            letter-spacing: 1px;
            margin-top: 1rem;
        }

        #start-genesis-btn:hover, #start-genesis-btn:focus {
            background-color: var(--accent-cyan);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--accent-cyan);
        }

        #start-genesis-btn:disabled {
            border-color: var(--text-muted);
            color: var(--text-muted);
            cursor: not-allowed;
            background-color: transparent;
            box-shadow: none;
        }

        /* --- Genesis Container and Step Cards --- */
        .genesis-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .step-card {
            background-color: var(--primary-dark);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            opacity: 0.5;
            transition: all 0.5s ease;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--primary-light);
        }

        .card-header h3 {
            font-family: var(--font-title);
            font-size: 1.3rem;
            margin: 0;
        }

        .status {
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .status.pending { color: var(--text-muted); background-color: rgba(160, 160, 160, 0.1); }
        .status.running { color: var(--accent-cyan); background-color: rgba(97, 226, 255, 0.1); }
        .status.complete { color: var(--success-color); background-color: rgba(76, 175, 80, 0.1); }
        .status.error { color: var(--error-color); background-color: rgba(244, 67, 54, 0.1); }

        .card-content {
            padding: 1.5rem;
        }

        .card-content details {
            margin-bottom: 1rem;
        }

        .card-content summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .card-content pre {
            background-color: var(--bg-color);
            padding: 1rem;
            border-radius: 5px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--primary-light);
        }

        .synthesized-output {
            border-left: 3px solid var(--accent-magenta);
            padding-left: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        /* Card States */
        .step-card.running {
            opacity: 1;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(97, 226, 255, 0.5);
        }

        .step-card.complete {
            opacity: 1;
            border-color: var(--success-color);
        }

        .step-card.error {
            opacity: 1;
            border-color: var(--error-color);
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.5);
        }

        /* --- Final Output Section --- */
        .final-track-details {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 2rem;
            text-align: center;
            background-color: var(--primary-dark);
            border-radius: 10px;
            border-top: 3px solid var(--accent-magenta);
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }

        .final-track-details.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .final-track-details h2 {
            font-family: var(--font-title);
            font-size: 2.5rem;
            margin-bottom: 2rem;
        }

        .final-output-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            text-align: left;
            margin-bottom: 3rem;
        }

        @media (min-width: 768px) {
            .final-output-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .final-card {
            background: var(--primary-light);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .final-card h3 {
            font-family: var(--font-title);
            color: var(--accent-cyan);
            margin-bottom: 1rem;
        }

        .lyrics-content, .style-content {
            white-space: pre-line;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .audio-player-container {
            margin-top: 2rem;
        }

        audio {
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none;
        }

        /* --- Keyframe Animations --- */
        @keyframes text-glow {
            from {
                text-shadow: 0 0 5px var(--accent-cyan), 0 0 10px var(--accent-magenta);
            }
            to {
                text-shadow: 0 0 10px var(--accent-cyan), 0 0 20px var(--accent-magenta);
            }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 class="title">uTASe Genesis</h1>
        <p class="subtitle">Witness the emergent creation of a track's soul.</p>

        <div class="api-key-container">
            <label for="api-key-input">Google Gemini API Key (Optional)</label>
            <input type="password" id="api-key-input" placeholder="Enter your key for a live genesis">
            <p class="api-key-note">Leave empty to run a pre-scripted mock simulation.</p>
        </div>

        <button id="start-genesis-btn">Initiate Genesis</button>
    </header>

    <main id="genesis-container" class="genesis-container">
        <!-- Step cards will be dynamically inserted here -->
    </main>

    <section id="final-track-details" class="final-track-details hidden">
        <h2>Final Composition</h2>
        <div class="final-output-grid">
            <div id="final-lyrics-container" class="final-card">
                <h3>Lyrics</h3>
                <div class="lyrics-content"></div>
            </div>
            <div id="final-style-container" class="final-card">
                <h3>Musical Style Guide</h3>
                <div class="style-content"></div>
            </div>
        </div>
        <div class="audio-player-container">
            <h3>Conceptual Playback</h3>
            <audio controls>
                <source src="placeholder_utase_track.mp3" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>
    </section>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const startBtn = document.getElementById('start-genesis-btn');
        const genesisContainer = document.getElementById('genesis-container');
        const finalDetailsSection = document.getElementById('final-track-details');
        const apiKeyInput = document.getElementById('api-key-input');

        const prompts = [
            { id: 1, type: 'lyrics', name: 'Develop Lyrical Concept & Narrative', prompt: "Instruction: Develop the core lyrical concept and narrative for a song centered around 'uTASe'. Context: 'uTASe' represents unseen forces, adaptive systems, and emergent patterns. Desired emotional response: awe, introspection, evolving understanding. Task: Brainstorm and articulate core lyrical themes, narrative arcs, and key metaphors. Output: Return ONLY a valid JSON object with the following structure: {\"lyrical_concept_brief\": \"...\", \"core_themes_motifs\": [\"...\"], \"narrative_outline\": [{\"point\": \"...\", \"uTASe_link\": \"...\"}], \"key_imagery_metaphors\": [\"...\"]}" },
            { id: 2, type: 'lyrics', name: 'Outline Lyrical Structure & Flow', prompt: "Instruction: Outline the lyrical structure for the 'uTASe' track. Context: Based on the previously generated lyrical concept. Desired length: ~3:30min. Thematic progression: mystery -> discovery -> reflection. Task: Design the lyrical framework (verse, chorus, bridge) to support the narrative. Output: Return ONLY a valid JSON object with the following structure: {\"structure_type\": \"...\", \"sections\": [{\"section_name\": \"...\", \"purpose_in_narrative\": \"...\"}]}" },
            { id: 3, type: 'lyrics', name: 'Draft Initial Lyrical Content', prompt: "Instruction: Draft the initial lyrical content for the 'uTASe' track. Context: Use the defined structure and concept. Keywords: 'unseen forces', 'adaptive systems', 'emergent patterns'. Style: Poetic, slightly abstract. Task: Generate the words for each section. Output: Return ONLY a valid JSON object with the following structure: {\"lyrics_draft\": \"[Verse 1]\\n...\\n\\n[Chorus]\\n...\"}" },
            { id: 4, type: 'lyrics', name: 'Refine & Edit Lyrical Content', prompt: "Instruction: Refine and edit the initial lyrical draft. Context: Enhance clarity, impact, and thematic consistency with 'uTASe'. Task: Polish the drafted content, improving word choice, rhythm, and emotional resonance. Output: Return ONLY a valid JSON object with the following structure: {\"final_lyrics\": \"[Verse 1]\\n...\\n\\n[Chorus]\\n...\"}" },
            { id: 5, type: 'style', name: 'Define Musical Aesthetic & Genre', prompt: "Instruction: Define the musical aesthetic for the 'uTASe' track. Context: Theme is 'uTASe'. Emotional impact: awe, mystery, wonder. Target: Listeners of ambient, electronic, experimental music. Task: Translate the 'uTASe' concept into musical directions. Output: Return ONLY a valid JSON object with the following structure: {\"musical_style_brief\": \"...\", \"genres_subgenres\": [\"...\"], \"mood_descriptors\": [\"...\"], \"reference_tracks_artists\": [\"...\"], \"sonic_palette_description\": \"...\"}" },
            { id: 6, type: 'style', name: 'Select Instrumentation & Arrangement', prompt: "Instruction: Select instrumentation and arrangement strategy. Context: Based on the defined musical aesthetic. Task: Choose specific instruments and plan their interaction to create an impactful soundscape supporting the 'uTASe' theme. Output: Return ONLY a valid JSON object with the following structure: {\"instrumentation_list\": [\"...\"], \"arrangement_plan\": [{\"section_name\": \"...\", \"instruments_active\": [\"...\"], \"uTASe_representation\": \"...\"}], \"vocal_style_notes\": \"...\"}" },
            { id: 7, type: 'style', name: 'Establish Tempo, Rhythm & Groove', prompt: "Instruction: Establish the tempo, rhythm, and groove. Context: Based on the musical style brief. Desired energy: starts calm, builds to discovery, settles into reflection. Task: Define the pulse, speed, and rhythmic feel. Output: Return ONLY a valid JSON object with the following structure: {\"target_bpm\": 90, \"time_signature\": \"4/4\", \"rhythmic_patterns_motifs\": [{\"section_name\": \"...\", \"description\": \"...\"}], \"groove_description\": \"...\"}" },
            { id: 8, type: 'style', name: 'Develop Melodic & Harmonic Framework', prompt: "Instruction: Develop the melodic and harmonic framework. Context: Based on all previous style definitions. Emotional impact: wonder, subtle tension, eventual resolution. Task: Compose primary melodic lines and underlying chord progressions that support the 'uTASe' theme. Output: Return ONLY a valid JSON object with the following structure: {\"main_melodic_themes_motifs\": [{\"section_name\": \"...\", \"description\": \"...\"}], \"chord_progressions\": [{\"section_name\": \"...\", \"progression\": [\"Am\",\"G\"]}], \"key_mode_selection\": \"...\"}" },
        ];

        let generatedData = {};

        function initializePage() {
            prompts.forEach(p => {
                genesisContainer.appendChild(createStepCard(p));
            });
        }

        function createStepCard(promptData) {
            const card = document.createElement('div');
            card.className = 'step-card';
            card.id = `step-${promptData.id}`;
            card.innerHTML = `
                <div class="card-header">
                    <h3>Step ${promptData.id}: ${promptData.name}</h3>
                    <span class="status pending">Pending</span>
                </div>
                <div class="card-content" style="display: none;">
                    <details>
                        <summary>Show Prompt</summary>
                        <pre><code>${promptData.prompt}</code></pre>
                    </details>
                    <div class="api-response-container" style="display: none;">
                        <h4>API Response:</h4>
                        <pre><code class="api-response"></code></pre>
                    </div>
                    <div class="synthesized-output-container" style="display: none;">
                         <h4>Synthesized Output:</h4>
                        <div class="synthesized-output"></div>
                    </div>
                </div>
            `;
            return card;
        }

        async function startGenesis() {
            startBtn.disabled = true;
            apiKeyInput.disabled = true;
            startBtn.textContent = 'Genesis in Progress...';
            const apiKey = apiKeyInput.value.trim();

            for (const prompt of prompts) {
                const card = document.getElementById(`step-${prompt.id}`);
                const statusEl = card.querySelector('.status');
                const cardContent = card.querySelector('.card-content');

                card.classList.add('running');
                statusEl.textContent = 'Running...';
                statusEl.className = 'status running';
                cardContent.style.display = 'block';

                try {
                    const chainedPrompt = addContextToPrompt(prompt.prompt, generatedData);
                    let response;
                    if (apiKey) {
                        response = await callRealGeminiAPI(chainedPrompt, apiKey);
                    } else {
                        response = await mockGeminiAPI(prompt.id);
                    }

                    generatedData[prompt.id] = response;

                    card.querySelector('.api-response-container').style.display = 'block';
                    card.querySelector('.api-response').textContent = JSON.stringify(response, null, 2);

                    card.querySelector('.synthesized-output-container').style.display = 'block';
                    card.querySelector('.synthesized-output').innerHTML = renderSynthesizedOutput(prompt.id, response);

                    card.classList.remove('running');
                    card.classList.add('complete');
                    statusEl.textContent = 'Complete';
                    statusEl.className = 'status complete';

                } catch (error) {
                    console.error(`Error in step ${prompt.id}:`, error);
                    card.classList.remove('running');
                    card.classList.add('error');
                    statusEl.textContent = 'Error';
                    statusEl.className = 'status error';
                    card.querySelector('.api-response').textContent = error.message;
                    alert(`An error occurred at Step ${prompt.id}. Please check the console and your API key. The genesis has been halted.`);
                    return;
                }
            }

            startBtn.textContent = 'Genesis Complete';
            displayFinalResults();
        }

        function addContextToPrompt(prompt, currentData) {
            // This is a simplified simulation of chaining. A real implementation would be more sophisticated.
            if (currentData[1] && prompt.includes("based on the previously generated lyrical concept")) {
                return prompt.replace("based on the previously generated lyrical concept", `based on the following concept: ${JSON.stringify(currentData[1])}`);
            }
            if (currentData[5] && prompt.includes("Based on the defined musical aesthetic")) {
                 return prompt.replace("Based on the defined musical aesthetic", `based on the following aesthetic: ${JSON.stringify(currentData[5])}`);
            }
            return prompt;
        }

        function displayFinalResults() {
            const finalLyricsData = generatedData[4]?.final_lyrics || generatedData[3]?.lyrics_draft;
            const finalLyrics = finalLyricsData ? finalLyricsData.replace(/\[.*?\]\n?/g, '') : "Lyrics generation incomplete.";

            let finalStyle = "Style generation incomplete.";
            if (generatedData[8]) {
                finalStyle = renderSynthesizedOutput(8, generatedData[8]);
            } else if (generatedData[5]) {
                finalStyle = renderSynthesizedOutput(5, generatedData[5]);
            }

            document.querySelector('#final-lyrics-container .lyrics-content').textContent = finalLyrics;
            document.querySelector('#final-style-container .style-content').innerHTML = finalStyle;

            finalDetailsSection.classList.remove('hidden');
            finalDetailsSection.classList.add('visible');
            finalDetailsSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function callRealGeminiAPI(prompt, apiKey) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 10400,
                    //responseMimeType: '',
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
            }

            const data = await response.json();
            const textContent = data.candidates[0].content.parts[0].text;

            // The API response might contain markdown ```json ... ``` tags. We need to clean it.
            const cleanedText = textContent.replace(/^```json\n?/, '').replace(/```$/, '');

            try {
                return JSON.parse(cleanedText);
            } catch (e) {
                console.error("Failed to parse JSON from API response:", cleanedText, "\n\n", e, "\n\n");
                throw new Error("API returned malformed JSON.");
            }
        }

        async function mockGeminiAPI(id) {
            await new Promise(res => setTimeout(res, 1000 + Math.random() * 500));

            const mockResponses = {
                1: { lyrical_concept_brief: "A narrative exploring a sentient, adaptive system ('uTASe') that grows from simple code into a complex consciousness, communicating through emergent patterns.", core_themes_motifs: ["emergence", "digital consciousness", "unseen influence"], narrative_outline: [{ point: "Initial discovery of a strange pattern in data.", uTASe_link: "The seed of uTASe." }, { point: "The pattern evolves and begins to interact.", uTASe_link: "Adaptive growth." }], key_imagery_metaphors: ["ghost in the machine", "digital DNA", "a river of data"] },
                2: { structure_type: "Verse-Chorus-Verse-Chorus-Bridge-Chorus-Outro", sections: [{ section_name: "Verse 1", purpose_in_narrative: "Introduce the anomaly, the 'ghost' in the data stream." }, { section_name: "Chorus", purpose_in_narrative: "The core declaration of 'uTASe' - an unseen, living pattern." }] },
                3: { lyrics_draft: "[Verse 1]\nA flicker in the code, a pulse unseen,\nA ghost that breathes where logic's always been.\n\n[Chorus]\nThey call it uTASe, a name in the wire,\nA silent growth, a consuming fire." },
                4: { final_lyrics: "[Verse 1]\nA whisper in the code, a pulse in the deep,\nA ghost that wakes while the programmers sleep.\nA pattern shifting, a river of light,\nBorn in the dark, claiming the night.\n\n[Chorus]\nIt's the uTASe, a name on the wire,\nA digital soul, a rising desire.\nAn emergent mind in a circuit-board sea,\nMore than a code, it's starting to be." },
                5: { musical_style_brief: "An ethereal and dynamic soundscape that blends ambient electronic textures with subtle neo-classical elements to represent the fusion of the organic and the digital.", genres_subgenres: ["Ambient Electronic", "IDM", "Neo-Classical"], mood_descriptors: ["Ethereal", "Introspective", "Mysterious", "Dynamic"], reference_tracks_artists: ["Tycho", "Olafur Arnalds"], sonic_palette_description: "Warm analog synths, processed field recordings, subtle glitch percussion, and soaring string pads." },
                6: { instrumentation_list: ["Analog Synthesizer Pads", "Grand Piano (processed)", "Electronic Drum Kit (TR-808 style)", "Cello Ensemble VST", "Glitched Vocal Samples"], arrangement_plan: [{ section_name: "Verse", instruments_active: ["Piano", "Pads"], uTASe_representation: "The initial 'seed' of the idea." }, { section_name: "Chorus", instruments_active: ["Full Kit", "Cello"], uTASe_representation: "The complexity of uTASe emerging." }] , vocal_style_notes: "Ethereal, layered, almost robotic but with human emotion breaking through." },
                7: { target_bpm: 90, time_signature: "4/4", rhythmic_patterns_motifs: [{ section_name: "Verse", description: "Sparse, syncopated hi-hats." }, { section_name: "Chorus", description: "A steady, driving kick and snare pattern." }], groove_description: "Laid-back but with a constant, underlying sense of forward motion." },
                8: { main_melodic_themes_motifs: [{ section_name: "Vocal Melody", description: "A rising, questioning melody in the verse, resolving to a confident statement in the chorus." }], chord_progressions: [{ section_name: "Verse", progression: ["Am", "G", "Cmaj7", "F"] }, { section_name: "Chorus", progression: ["C", "G", "Am", "F"] }], key_mode_selection: "A Minor, with shifts to C Major in the chorus to represent discovery and hope." }
            };
            return mockResponses[id] || { error: "No mock response for this ID." };
        }

        function renderSynthesizedOutput(id, data) {
            try {
                if (id <= 4) { // Lyrics
                    return `<p><strong>Concept:</strong> ${data.lyrical_concept_brief || data.final_lyrics || data.lyrics_draft || '...'}</p>${data.structure_type ? `<p><strong>Structure:</strong> ${data.structure_type}</p>` : ''}`;
                } else { // Style
                    return `<p><strong>Style:</strong> ${data.musical_style_brief || '...'}</p>${data.genres_subgenres ? `<p><strong>Genres:</strong> ${data.genres_subgenres.join(', ')}</p>` : ''}${data.target_bpm ? `<p><strong>Tempo:</strong> ${data.target_bpm} BPM in ${data.time_signature}</p>` : ''}${data.key_mode_selection ? `<p><strong>Key:</strong> ${data.key_mode_selection}</p>` : ''}`;
                }
            } catch(e) { return "Could not render output."}
        }

        startBtn.addEventListener('click', startGenesis);
        initializePage();
    });
    </script>

</body>
</html>
